{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (value) => typeof value === 'object' && value !== null;\r\nexport const extend = Object.assign;\r\n\r\n\r\nconst Shared = {\r\n  isObject,\r\n};\r\n\r\nexport {\r\n  Shared,\r\n};\r\n","import { TrackOpTypes } from \"./operators\";\r\n\r\nexport function effect(fn: Function, options: any = {}) {\r\n  // 需要让这个effect变成响应式的effect, 可以做到数据变化重新执行\r\n  const effective = createReactiveEffect(fn, options);\r\n\r\n  if (!options.lazy) {\r\n    effective();\r\n  }\r\n\r\n  return effective;\r\n}\r\n\r\nlet eid = 0;\r\nlet effectStack = [];\r\nlet activeEffect = null;\r\nfunction createReactiveEffect(fn: Function, options: any = {}):Function {\r\n  const effective = function reactiveEffect() {\r\n    if (!effectStack.includes(effective)) {\r\n      try {\r\n        effectStack.push(effective);\r\n        activeEffect = effective;\r\n        return fn();\r\n      } finally {\r\n        effectStack.pop();\r\n        activeEffect = effectStack[effectStack.length - 1];\r\n      }\r\n    } else {\r\n      console.warn('circular assign effect!');\r\n    }\r\n  };\r\n  effective.id = eid++; // 区分effect\r\n  effective._isEffect = true; // 用于标识这个是响应式effect\r\n  effective.raw = fn;\r\n  effective.options = options;\r\n\r\n  return effective;\r\n}\r\n\r\nconst targetMap = new WeakMap();\r\nexport function track(target, type:TrackOpTypes, key) {\r\n  if (activeEffect) {\r\n    // target对应的Map\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n      targetMap.set(target, (depsMap = new Map));\r\n    }\r\n    // target对应的Map中 对应的key对应的Set\r\n    let deps = depsMap.get(key);\r\n    if (!deps) {\r\n      depsMap.set(key, (deps = new Set));\r\n    }\r\n    if (!deps.has(activeEffect)) {\r\n      deps.add(activeEffect);\r\n    }\r\n  }\r\n}","import { extend, isObject } from \"@vue/shared\";\r\nimport { track } from \"./effect\";\r\nimport { TrackOpTypes } from \"./operators\";\r\nimport { reactive, readonly } from \"./reactive\";\r\n\r\nfunction createGetter(\r\n  isReadonly = false,\r\n  shallow = false\r\n) {\r\n  return function get(target, key, receiver) {\r\n    const res = Reflect.get(target, key, receiver);\r\n\r\n    if (!isReadonly) {\r\n      // 不是仅读的，就收集依赖，数据改变后更新对应的视图\r\n      console.log('收集', target, key);\r\n      track(target, TrackOpTypes.GET, key);\r\n    }\r\n\r\n    if (shallow) {\r\n      return res;\r\n    }\r\n\r\n    if (isObject(res)) {\r\n      return isReadonly ? readonly(res) : reactive(res);\r\n    }\r\n\r\n    return res;\r\n  }\r\n};\r\n\r\nfunction createSetter(\r\n  shallow = false\r\n) {\r\n  return function set(target, key, value, receiver) {\r\n    const result = Reflect.set(target, key, value, receiver);\r\n\r\n    // 当数据更新时，通知对应属性的effect重新执行\r\n\r\n    return result;\r\n  }\r\n}\r\n\r\nconst get = createGetter();\r\nconst shallowGet = createGetter(false, true);\r\nconst readonlyGet = createGetter(true);\r\nconst shallowReadonlyGet = createGetter(true, true);\r\n\r\nconst set = createSetter();\r\nconst shallowSet = createSetter(true);\r\n\r\nconst readonlyObject = {\r\n  set: (target, key) => {\r\n    console.warn(`set on key [${key}] failed , [${key}']s originValue is ${target[key]}`);\r\n  }\r\n};\r\n\r\nexport const mutableHandlers = {\r\n  get,\r\n  set,\r\n};\r\n\r\nexport const shallowReactiveHandlers = {\r\n  get: shallowGet,\r\n  set: shallowSet,\r\n};\r\n\r\nexport const readonlyHandlers = extend({\r\n  get: readonlyGet,\r\n}, readonlyObject);\r\n\r\nexport const shallowReadonlyHandlers = extend({\r\n  get: shallowReadonlyGet,\r\n}, readonlyObject);\r\n","import { isObject } from \"@vue/shared\";\r\nimport { mutableHandlers, readonlyHandlers, shallowReactiveHandlers } from \"./baseHandlers\";\r\n\r\nexport function reactive(target) {\r\n  return createReactiveObject(target, false, mutableHandlers);\r\n};\r\n\r\nexport function shallowReactive(target) {\r\n  return createReactiveObject(target, false, shallowReactiveHandlers);\r\n};\r\n\r\nexport function readonly(target) {\r\n  return createReactiveObject(target, true, readonlyHandlers);\r\n};\r\n\r\nexport function shallowReadonly(target) {\r\n  return createReactiveObject(target, true, shallowReactiveHandlers);\r\n};\r\n\r\nconst reactiveMap = new WeakMap(); // 会自动垃圾回收，不会造成内存泄漏\r\nconst readonlyMap = new WeakMap();\r\n\r\nexport function createReactiveObject(target, isReadonly: boolean, baseHandlers) {\r\n  // 如果目标不是对象，那就没法拦截\r\n  if (!isObject(target)) {\r\n    return target;\r\n  }\r\n\r\n  const proxyMap = isReadonly ? reactiveMap : readonlyMap;\r\n\r\n  const exisitProxy = proxyMap.get(target);\r\n  if (exisitProxy) return exisitProxy;\r\n\r\n  const proxy = new Proxy(target, baseHandlers);\r\n  proxyMap.set(target, proxy); // 将要代理的对象和对应的代理结果缓存起来\r\n\r\n  return proxy;\r\n};"],"names":[],"mappings":"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"}