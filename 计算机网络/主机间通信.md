## 主机间通信

主机间通信可以直接用一条交叉线链接两台主机

主机间发包通过**ICMP**协议进行**IP**层面的通信

若不知道目标主机的MAC地址，在发**ICMP**之前需要发送**ARP**广播找到目标主机的MAC地址



### MAC地址

每一个网卡都有一个6字节(48bit)的MAC地址

MAC地址**全球唯一**，固化在了网卡的ROM当中，由IEEE802标准规定

前三个字符: OUI，组织唯一标识符，一般用来分辨厂商，由IEEE的注册管理机构分配给厂商

后三个字符: 由厂商自由分配

**当48位全部为1时，代表广播**



### IP地址

互联网上每一个主机都有一个IP地址

最初版本是IPv4版本，32 bit(4字节)，2019年11月25日，全球的IP地址已经用完

后面推出了IPv6版本，128 bit(16字节)

一般IP地址会用点分十进制的方法表示

IP地址有两部分组成：**网络标识**，**主机标识**

通过子网掩码可以计算出网络标识(按位与[&]) 



#### **5类地址**

- A类地址

  0开头，网络号8位

- B类地址

  10开头，网络号16位

- C类地址

  110开头，网络号24位

- D类地址

  1110开头，多播地址

- E类地址

  1111开头，保留为今后拓展使用

  

#### 子网掩码的CIDR表示方法

123.210.100.200/16代表子网掩码有16个1



#### **划分子网**

***为什么要进行子网划分?***

如果需要让200台主机在同一个网段内，可以分配一个C类网段，比如192.168.1.0/24

多出了54个空闲的IP地址，这种情况并不算浪费资源

但是如果需要让500台主机在同一个网段内，那么就分配一个B类网段比如192.100.0.0/16

总共有65534个可用IP地址: 191.100.0.1 ~ 191.100.255.254

多出了65034个空闲的IP地址, 这种情况属于极大的资源浪费

这个时候就可以用到子网划分



子网划分可以分为**等长子网划分**和**变长子网划分**

- 等长子网划分：将一个网段等分为多个子网，每个子网的可用IP地址是一样的

  

  **等长子网划分-等分为两个子网**

  规律：如果一个子网是原来网络的1/2，子网掩码往后移一位(用一位主机号来表示网络号)

  *例*

  192.168.0.0/24 划分为2个子网段

  A子网:  192.168.0.128/25     子网掩码: 255.255.255.128

  主机:192.168.0.1 ~ 192.168.0.126	126台

  B子网:  192.168.0.0/25     子网掩码: 255.255.255.128

  主机:192.168.0.129 ~ 192.168.0.254	126台

  ​	

- 变长子网划分：每个子网的可用IP地址数量可以是不一样的

  如果一个子网地址块的长度是原网段的(1/2)^n，那么

  - 子网的子网掩码就是在原网段的子网掩码基础上增加n个1
  - 不等长的子网，他们的子网掩码也不同



*例:*

A: 192.168.10.10/24发包给B: 192.168.10.10/16

虽然我们主观算出来两台主机在同一个网段内，但在A发包给B时，A要判断B是否和自己在同一个网段，但是A并不知道B的子网掩码是多少，于是会用A自己的子网掩码算出B所在的网段，这样得出的结果二者是不在同一个网段的，所以无法通过局域网通信。



#### 构造超网

超网：跟子网反过来，它是将多个**连续的网段**合并成**一个更大的网段**

需求：原本有200台计算机使用192.168.0.0/24网段，现在希望增加200台设备到同一网段

- 方法1: 200台在192.168.0.0/24网段，200台在192.168.1.0/24网段(分配到不同网段)
- 方法2: 合并192.168.0.0/24和192.168.1.0/24为一个网段: 192.168.0.0/23 (子网掩码往左移动一位)



**合并网段的规律**

假设n是2的k次幂(k>=1)

子网掩码左移k位能够合并n个网段(**不是任意连续的网段都能合并！**)

如果第一个网段的网络号能被n整除，那么由它开始连续的n个网段都能通过左移k位子网掩码进行合并(左移k位后网络号相同就代表可以合并)



#### 判断一个网段是子网还是超网

首先

看看该网段的类型是A类网络，还是B类网络，或者C类网络

默认情况下A类网络的子网掩码是8位，B类的是16位，C类的是24位

然后

如果该网段的子网掩码位数比默认子网掩码**多**就是**子网**

如果该网段的子网掩码位数比默认子网掩码**少**就是**超网**



### ARP协议

**ARP协议会在主机间广播获取到各个主机的MAC地址与IP地址的映射**

ARP地址在设备本地是有缓存的



### **ICMP协议**

**ICMP协议是一个网络层协议。**

一个新搭建好的网络，往往需要先进行一个简单的测试，来验证网络是否畅通；但是IP协议并不提供可靠传输。如果丢包了，IP协议并不能通知传输层是否丢包以及丢包的原因，所以我们就需要一种协议来完成这样的功能–ICMP协议。

ICMP协议的功能主要有：

1. 确认IP包是否成功到达目标地址
2. 通知在发送过程中IP包被丢弃的原因
3. ICMP是基于IP协议工作的，但是它并不是传输层的功能，因此仍然把它归结为网络层协议
4. ICMP只能搭配IPv4使用，如果是IPv6的情况下, 需要是用ICMPv6



### STP协议(生成树协议)

**生成树协议工作原理**:任意一交换机中如果到达根网桥有两条或者两条以上的链路.生成树协议都根据算法仅仅保留一条，把其他切断，从而保证任意两个交换机之间只有一条单一的活动链路。因为这种生成的这种拓扑结构，很像是以根交换机为树干的树形结构.故为生成树协议。

**STP的工作过程如下**：首先进行根网桥的选举，其依据是网桥优先级（bridge priority）和MAC地址组合生成的桥ID，桥ID最小的网桥将成为网络中的根桥（bridge root）。在此基础上，计算每个节点到根桥的距离，并由这些路径得到各冗余链路的代价，选择最小的成为通信路径（相应的端口状态变为forwarding），其它的就成为备份路径(相应的端口状态变为blocking)。STP生成过程中的通信任务由BPDU完成，这种数据包又分为包含配置信息的配置BPDU（其大小不超过35B）和包含拓扑变化信息的通知BPDU（其长度不超过4B）。



### 局域网内多台主机间的通信

#### 总线形式

多台计算机连接在同一条同轴电缆，这种方式是半双工通信

同轴电缆的传播方式是广播，容易造成碰撞，可以借助**碰撞检测协议**来实现信息的传递

同轴电缆两端是电阻会吸收信号，避免信号回弹

容错率低，如果总线断了，那么信号可能不会遇到电阻造成信号回弹

一条总线连接的所有主机称为一个**冲突域**



#### 集线器形式

用集线器把所有主机连起来，可以用集线器连接集线器，来拓展网络

容错率好，一台主机失联对全局影响不大

**集线器没有智商，给集线器发包，集线器只会把包发往其它所有连接的端口**

如果多台主机连在同一个集线器上，会造成发送过多的无用包导致性能浪费



#### 网桥连接

**网桥连接能够通过自学习得知每个接口那侧的MAC地址**

网桥只有两个接口

网桥内部会有一个MAC地址表

| 端口 | MAC地址 |
| ---- | ------- |
| L    | MAC(1)  |
| R    | MAC(2)  |
| L    | MAC(3)  |
| L    | MAC(4)  |
| R    | MAC(5)  |
| ...  | ...     |

网桥在转发数据包时，如果发现数据包的目的地和它来的端口是同一个端口，那么网桥不会转发这个包，从而起到**隔绝冲突域**的作用



#### 交换机

相当于更多接口的网桥,也有**隔绝冲突域**的作用

**全双工通信**

**交换机是局域网的最终方案，若要跨网段，则要用到路由器**

交换机也会学习各个接口对应的MAC地址，若要转发的包在MAC地址表内找到匹配端口，则交换机只会把包转到对应的端口而不会影响其他端口

不在同一个网段的主机不能用交换机连接，连接了数据也发不过去

但是如果全球都用交换机连接是不可行的

1. 首先交换机连接的是同一个网段的主机，会造成IP地址不够用
2. ARP广播会发给全球的人

**所以说如果要连接多个网络的话，交换机还是不能解决问题**



### 互联网内多台主机间的通信



网线直连，同轴电缆，集线器，网桥，交换机连接的设备必须在同一网段，连接的设备处在同一个广播域



#### 路由器

路由器可以在不同网段之间转发数据

有**隔绝广播域**的作用

主机发送数据之前，首先会判断目标主机的IP地址是否跟它在同一个网段

- 在同一个网段：ARP，通过交换机，集线器发送数据
- 不在同一个网段：通过路由器转发数据

主机把数据包发往自己所处广播域的路由器的网关(默认网关), 然后路由器根据路由表进行转发

#### 网关

如果想要跨网段发送数据，需要通过连接的路由器的网关



### **路由**

在不同网段之间转发数据，需要有路由器的支持

默认情况下，路由器只知道跟它直连的网段，非直连的网段需要通过静态路由，动态路由告诉他



#### 静态路由

管理员手动添加的路由信息

适用于小规模网络



#### 动态路由

路由器通过**路由选择协议**(比如RIP，OSPF)自动获取路由信息

适用于大规模网络















